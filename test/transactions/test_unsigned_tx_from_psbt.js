const {deepStrictEqual} = require('node:assert').strict;
const {throws} = require('node:assert').strict;
const test = require('node:test');

const {unsignedTxFromPsbt} = require('./../../');

const hexAsBuffer = hex => Buffer.from(hex, 'hex');

const tests = [
  {
    args: {},
    description: 'A psbt is required',
    error: 'ExpectedPsbtToGetUnsignedTransaction',
  },
  {
    args: {
      psbt: '0200000001268171371edff285e937adeea4b37b78000c0566cbb3ad64641713ca42171bf6000000006a473044022070b2245123e6bf474d60c5b50c043d4c691a5d2435f09a34a7662a9dc251790a022001329ca9dacf280bdf30740ec0390422422c81cb45839457aeb76fc12edd95b3012102657d118d3357b8e0f4c2cd46db7b39f6d9c38d9a70abcb9b2de5dc8dbfe4ce31feffffff02d3dff505000000001976a914d0c59903c5bac2868760e90fd521a4665aa7652088ac00e1f5050000000017a9143545e6e33b832c47050f24d3eeb93c9c03948bc787b32e1300',
    },
    description: 'A valid psbt is required',
    error: 'ExpectedKnownPsbtStartBytesToGetUnsignedTransaction',
  },
  {
    args: {
      psbt: '70736274ff0100fd630102000000030146055816a5ce735defea7c69abb584946fadb54befc4ce55eb039f9ccfdda10000000000ffffffff16d3dad203d4d016ede6ffef29ed24b1bce4ba8efbe4ad8482bacf65d92ed57e0000000000ffffffff01e7e7e51596634dbccb27ee5031276293f2765084b72a889d5bb0aa84425ad80000000000ffffffff06a0860100000000002200203a291e21dee6c814294f159dcf259e9e82ffa3881fd09b22537400b8c5a8d0c8c76a042a01000000160014ca4be4a08bbd2acc8431e920a41f7ccfcd8fc8ada086010000000000220020f21b761d396210ba5cfd796db936bef36432f13d20afe55b57872a090415ce98c76a042a010000001600148b25e25be092a33e4524a9b2da5046fcc6e27e05a086010000000000220020eed63c2f9175915a94ad626ba35dcbf876a72116ea6fbd50b094b08b347e8688c76a042a010000001600147e5b3b51cc3217ac8f384a665285f90a4dd6826a0000000000000100a9020000000001010000000000000000000000000000000000000000000000000000000000000000ffffffff0401680101ffffffff0200f2052a01000000160014fb9ae43f439741acb5d4f2813b4177adb09a52950000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf9012000000000000000000000000000000000000000000000000000000000000000000000000001011f00f2052a01000000160014fb9ae43f439741acb5d4f2813b4177adb09a52952202025008f4d43049ea3ff9e71bca9b96402cc92c1c911adebcf5722d94e5bc84b48f47304402202e7f867ac0647b7c659d8742a0dae894437354106c98413a4b7beea2758e973502205787be7f941ecdda56cc099b297d4f71dfca5e859c6f5709852a1efd9d6995cc01010304010000002206025008f4d43049ea3ff9e71bca9b96402cc92c1c911adebcf5722d94e5bc84b48f180000000054000080000000800000008000000000010000000000000000000000',
    },
    description: 'An unsigned tx with empty inputs is pulled out of the PSBT',
    expected: {
      transaction: hexAsBuffer('02000000030146055816a5ce735defea7c69abb584946fadb54befc4ce55eb039f9ccfdda10000000000ffffffff16d3dad203d4d016ede6ffef29ed24b1bce4ba8efbe4ad8482bacf65d92ed57e0000000000ffffffff01e7e7e51596634dbccb27ee5031276293f2765084b72a889d5bb0aa84425ad80000000000ffffffff06a0860100000000002200203a291e21dee6c814294f159dcf259e9e82ffa3881fd09b22537400b8c5a8d0c8c76a042a01000000160014ca4be4a08bbd2acc8431e920a41f7ccfcd8fc8ada086010000000000220020f21b761d396210ba5cfd796db936bef36432f13d20afe55b57872a090415ce98c76a042a010000001600148b25e25be092a33e4524a9b2da5046fcc6e27e05a086010000000000220020eed63c2f9175915a94ad626ba35dcbf876a72116ea6fbd50b094b08b347e8688c76a042a010000001600147e5b3b51cc3217ac8f384a665285f90a4dd6826a00000000'),
    },
  },
  {
    args: {
      psbt: '70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f000000000000000000',
    },
    description: 'An blank tx is pulled out of the PSBT',
    expected: {
      transaction: hexAsBuffer('020000000258e87a21b56daf0c23be8e7070456c336f7cbaa5c8757924f545887bb2abdd750000000000ffffffff838d0427d0ec650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d0100000000ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb815e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df5546e8742d1d87008f00000000'),
    },
  },
  {
    args: {
      psbt: '70736274ff0100a00200000002ab0949a08c5af7c49b8212f417e2f15ab3f5c33dcf153821a8139f877a5b7be40000000000feffffffab0949a08c5af7c49b8212f417e2f15ab3f5c33dcf153821a8139f877a5b7be40100000000feffffff02603bea0b000000001976a914768a40bbd740cbe81d988e71de2a4d5c71396b1d88ac8e240000000000001976a9146f4620b553fa095e721b9ee0efe9fa039cca459788ac000000000001076a47304402204759661797c01b036b25928948686218347d89864b719e1f7fcf57d1e511658702205309eabf56aa4d8891ffd111fdf1336f3a29da866d7f8486d75546ceedaf93190121035cdc61fc7ba971c0b501a646a2a83b102cb43881217ca682dc86e2d73fa882920001012000e1f5050000000017a9143545e6e33b832c47050f24d3eeb93c9c03948bc787010416001485d13537f2e265405a34dbafa9e3dda01fb82308000000',
    },
    description: 'An tx with varied inputs is pulled out of the PSBT',
    expected: {
      transaction: hexAsBuffer('0200000002ab0949a08c5af7c49b8212f417e2f15ab3f5c33dcf153821a8139f877a5b7be40000000000feffffffab0949a08c5af7c49b8212f417e2f15ab3f5c33dcf153821a8139f877a5b7be40100000000feffffff02603bea0b000000001976a914768a40bbd740cbe81d988e71de2a4d5c71396b1d88ac8e240000000000001976a9146f4620b553fa095e721b9ee0efe9fa039cca459788ac00000000'),
    },
  },
  {
    args: {
      psbt: '70736274ff0100750200000001268171371edff285e937adeea4b37b78000c0566cbb3ad64641713ca42171bf60000000000feffffff02d3dff505000000001976a914d0c59903c5bac2868760e90fd521a4665aa7652088ac00e1f5050000000017a9143545e6e33b832c47050f24d3eeb93c9c03948bc787b32e1300000100fda5010100000000010289a3c71eab4d20e0371bbba4cc698fa295c9463afa2e397f8533ccb62f9567e50100000017160014be18d152a9b012039daf3da7de4f53349eecb985ffffffff86f8aa43a71dff1448893a530a7237ef6b4608bbb2dd2d0171e63aec6a4890b40100000017160014fe3e9ef1a745e974d902c4355943abcb34bd5353ffffffff0200c2eb0b000000001976a91485cff1097fd9e008bb34af709c62197b38978a4888ac72fef84e2c00000017a914339725ba21efd62ac753a9bcd067d6c7a6a39d05870247304402202712be22e0270f394f568311dc7ca9a68970b8025fdd3b240229f07f8a5f3a240220018b38d7dcd314e734c9276bd6fb40f673325bc4baa144c800d2f2f02db2765c012103d2e15674941bad4a996372cb87e1856d3652606d98562fe39c5e9e7e413f210502483045022100d12b852d85dcd961d2f5f4ab660654df6eedcc794c0c33ce5cc309ffb5fce58d022067338a8e0e1725c197fb1a88af59f51e44e4255b20167c8684031c05d1f2592a01210223b72beef0965d10be0778efecd61fcac6f79a4ea169393380734464f84f2ab300000000000000',
    },
    description: 'A simple transaction is pulled out of the PSBT',
    expected: {
      transaction: hexAsBuffer('0200000001268171371edff285e937adeea4b37b78000c0566cbb3ad64641713ca42171bf60000000000feffffff02d3dff505000000001976a914d0c59903c5bac2868760e90fd521a4665aa7652088ac00e1f5050000000017a9143545e6e33b832c47050f24d3eeb93c9c03948bc787b32e1300'),
    },
  },
];

tests.forEach(({args, description, error, expected}) => {
  return test(description, (t, end) => {
    if (!!error) {
      throws(() => unsignedTxFromPsbt(args), new Error(error), 'Got err');
    } else {
      const res = unsignedTxFromPsbt(args);

      deepStrictEqual(res, expected, 'Got expected result');
    }

    return end();
  });
});
